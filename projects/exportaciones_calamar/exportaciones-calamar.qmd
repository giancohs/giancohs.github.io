---
title: "Exportaciones de calamar: Perú, Chile y Ecuador"
format: html
editor: visual
execute:
  echo: false
  message: false 
  warning: false
---

## Contexto

El objetivo del análisis es conocer el mercado de exportaciones de calamar en los países de Perú, Ecuador y Chile; identificar los principales países de destino y empresas.

Luego de revisar el diccionario de partidas arancelarias se determinó que se descargará data de las siguientes partidas:

-   0307.42.00.00: Jibias (sepias) y globitos; calamares y potas. Vivos, frescos o refrigerados

-   0307.43.00.00: Jibias (sepias) y globitos; calamares y potas. Congelados.

-   0307.49.00.00: Jibias (sepias) y globitos; calamares y potas. Los demás.

-   1605.54.00.00: Moluscos. Jibias (sepias), globitos, calamares y potas.

Luego se hará un filtro con palabra clave para quedarnos solo con las que corresponden a Calamar:

-   dosidicus gigas

-   calamar

-   pota

## Fuentes

-   Exportaciones calamar Perú, Panjiva de enero 2015 a 25 septiembre de 2022.

-   Exportaciones calamar Ecuador, Panjiva de enero 2015 a 31 julio de 2022. Para este caso, no se halló registros mediante búsqueda de partida, pero sí mediante palabras clave. Es decir, en Panjiva se hizo la búsqueda del campo "GOODS SHIPPED" las palabras clave y los HS Code, ya que carecía de una variable propia para hacer búsqueda por partida. Igual son muy pocos registros.

-   Exportaciones calamar Chile, Panjiva de enero de 2014 a 31 julio de 2022.

```{r}
library(here)
library(scales)
library(reactable)


source(
  paste0(here(),"/scripts/00_get-data.R")
)
source(
  paste0(here(), "/scripts/01_clean-data.R")
)
source(
  paste0(here(), "/scripts/02_modelling-data.R")
)
```

## Análisis

Vamos a revisar registros aleatorios de Peru y los otros paises para entender superficialmente cómo es la ruta de los envíos.

::: panel-tabset
### Peru

```{r}
peru_exports_calamar %>% 
  sample_n(5) %>% 
  reactable(wrap = F)
  
```

### Chile

```{r}
chile_exports_calamar %>% sample_n(5) %>% reactable(wrap = F)

```

### Ecuador

```{r}
ecuador_exports_calamar %>% sample_n(5) %>% reactable(wrap = F,fullWidth = T)

```
:::

\
Los registros de Perú no permite conocer el origen real del envío. Es decir, puede estar saliendo pota o calamar pescado en Ecuador pero no hay datos que lo confirmen. Solo se conoce que salió por un puerto de Perú, y asumir que la mayoría es de origen peruano. Ecuador tiene poco registros, pero en los pocos datos se pudo comprobar que algunos productos eran de origen peruano pero salian por puertos ecuatorianos. En el caso de Chile es similar. Lo unico seguro en los tres paises es que salió de un puerto correspondiente al país y el destino final del envío (que en su mayoria son paises asiaticos como Korea, China, o en Europa España.). Además, solo Ecuador tiene registros de la empresa compradora de las mercancías (Consignatario).

### Evolución de exportaciones en Perú, Chile y Ecuador

De los tres países, Perú es el que más toneladas de calamar exporta al extranjero. El 2021 creció en un 30% respecto al año anterior, muy cerca al pico histórico del 2019 que llegó a un total de 382 mil toneladas exportadas.

En el caso de Chile, los registros muestran un reducción de las exportaciones de calamar en los últimos años, llegando apenas a 35 mil toneladas el 2021.

Ecuador solo tiene registros de exportaciones desde el 2015 hasta el 2020, y sus cifras son muy reducidas si se compara con Perú Chile. Por ejemplo, el 2020 llegó a exportar apenas 83 toneladas.

```{r}
theme_set(theme_minimal())
theme_update(text = element_text(family = "sans", color = "#464a62"))
theme_update(plot.title = element_text(hjust = 0.5, face = "bold"))
theme_update(plot.subtitle = element_text(hjust = 0.5))
```

::: panel-tabset
## Gráfico

```{r}
exports_calamar %>% 
  group_by(año_envio,fuente_data) %>% 
  summarise(
    peso_bruto_ton = sum(peso_bruto_ton,na.rm = T)
  ) %>% 
  ggplot(
    aes(x=año_envio,y=peso_bruto_ton,fill = fuente_data)
  )+
  geom_bar(position = "dodge",
           stat = "identity")+
  scale_y_continuous(label = scales::label_number(suffix = " TM", big.mark = "."),
                     breaks = seq(0,400000, 50000))+
   labs(fill = "País origen",
         title = "Evolución de exportaciones de calamar en Chile, Ecuador y Perú",
         subtitle = "Por peso bruto en toneladas métricas (TM)",
         y = "Peso bruto",
         x = "Año")
  
```

## Tabla

```{r}

exports_calamar %>% 
  group_by(año_envio, fuente_data) %>% 
  summarise(
    peso_bruto_tm = sum(peso_bruto_ton,na.rm = T)
  ) %>% 
  pivot_wider(
    names_from = fuente_data, values_from = peso_bruto_tm
  ) %>% 
  reactable::reactable( 
    theme = reactableTheme(
    borderColor = "#dfe2e5",
    stripedColor = "#f6f8fa",
    highlightColor = "#f0f5f9",
    cellPadding = "8px 12px",
    style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"),
    searchInputStyle = list(width = "100%")
  ),
  columns = list(
    Chile = colDef(format = colFormat(suffix = " TM", digits = 0, separators = T,locales = "es-AR")),
    Ecuador = colDef(format = colFormat(suffix = " TM", digits = 0, separators = T,locales = "es-AR")),
    Perú = colDef(format = colFormat(suffix = " TM", digits = 0, separators = T,locales = "es-AR"))
  ))
```
:::

### Principales destino del calamar/pota

Los principales destinos de la pota exportada por los tres países son China, España y Corea del Sur. El detalle se puede ver en la siguiente tabla.

```{r}
#Creando función para formato de tabla
tabla_format <- function(data_input){
 data_input %>% 
 group_by(destino_envio) %>% 
  summarise(
    peso_bruto_ton = sum(peso_bruto_ton,na.rm = T)
  ) %>% 
  mutate(
    porcentaje = peso_bruto_ton*100/sum(peso_bruto_ton,na.rm = T)
  ) %>% 
  arrange(-peso_bruto_ton) %>% 
  reactable(
    columns = list(
      destino_envio = colDef(
        footer = "Total"),
      peso_bruto_ton = colDef(
        format = colFormat(suffix = " TM", digits = 0, separators = T,locales = "es-AR"),
        footer = function(values) paste0(format(round(sum(values),digits = 0), big.mark = ".")," TM")),
      porcentaje = colDef(
        format = colFormat(suffix = " %", digits = 2, separators = T,locales = "es-AR"))
    ),
    defaultColDef = colDef(footerStyle = list(fontWeight = "bold"))
  )
}
```

```{r}
library(sparkline)

tabla_format_2 <- function(data_input){
  
 max_value <- data_input %>% 
      group_by(destino_envio, año_envio) %>% 
      summarise(
        peso_bruto_tm = sum(peso_bruto_ton,na.rm = T)
      )
 
 data_input %>% 
 group_by(destino_envio) %>% 
  summarise(
    peso_bruto_ton = sum(peso_bruto_ton,na.rm = T)
  ) %>% 
  mutate(
    porcentaje = peso_bruto_ton*100/sum(peso_bruto_ton,na.rm = T)
  ) %>% 
  arrange(-peso_bruto_ton) %>% 
  left_join(
   data_input %>% 
      group_by(destino_envio, año_envio) %>% 
      summarise(
        peso_bruto_tm = sum(peso_bruto_ton,na.rm = T)
      ) %>% 
  arrange(año_envio) %>% 
  pivot_wider(names_from = año_envio,values_from = peso_bruto_tm) %>% 
  pivot_longer(cols = -1, names_to = "año_envio", values_to = "peso_bruto_tm") %>% 
  mutate(
    peso_bruto_tm = case_when(
      is.na(peso_bruto_tm) ~ 0,
      T ~ peso_bruto_tm
    )
  ) %>% 
  group_by(destino_envio) %>% 
  summarise(
    evolution_tm = list(peso_bruto_tm)
  )
  ) %>% 
  reactable(
    columns = list(
      destino_envio = colDef(
        footer = "Total"),
      peso_bruto_ton = colDef(
        format = colFormat(suffix = " TM", digits = 0, separators = T,locales = "es-AR"),
        footer = function(values) paste0(format(round(sum(values),digits = 0), big.mark = ".")," TM")),
      porcentaje = colDef(
        format = colFormat(suffix = " %", digits = 2, separators = T,locales = "es-AR")),
      evolution_tm = colDef(
        cell = function(values) {
    sparkline(values, type = "bar", chartRangeMin = 0)
  })
    ),
    defaultColDef = colDef(footerStyle = list(fontWeight = "bold"))
  )
}
```

::: panel-tabset
## Perú+Chile+Ecuador

::: panel-tabset
## Total 2015-2021

```{r}
exports_calamar %>% 
  filter(!año_envio== '2022') %>% 
  tabla_format_2()
```

## 2021

```{r}
exports_calamar %>% 
  filter(año_envio == '2021') %>% 
  tabla_format()
```

## 2020

```{r}
exports_calamar %>% 
  filter(año_envio == '2020') %>% 
  tabla_format()
```

## 2019

```{r}
exports_calamar %>% 
  filter(año_envio == '2019') %>% 
  tabla_format()
```

## 2018

```{r}
exports_calamar %>% 
  filter(año_envio == '2018') %>% 
  tabla_format()
```

## 2017

```{r}
exports_calamar %>% 
  filter(año_envio == '2017') %>% 
  tabla_format()
```
:::

## Perú

::: panel-tabset
## Total 2015-2021

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         !año_envio == '2022') %>% 
  tabla_format_2()
```

## 2021

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2021') %>% 
  tabla_format()
```

## 2020

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2020') %>% 
  tabla_format()
```

## 2019

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2019') %>% 
  tabla_format()
```

## 2018

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2018') %>% 
  tabla_format()
```

## 2017

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2017') %>% 
  tabla_format()
```
:::

## Chile

::: panel-tabset
## Total 2015-2021

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         !año_envio == '2022') %>% 
  tabla_format_2()
```

## 2021

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         año_envio == '2021') %>% 
  tabla_format()
```

## 2020

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         !año_envio == '2020') %>% 
  tabla_format()
```

## 2019

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         !año_envio == '2019') %>% 
  tabla_format()
```

## 2018

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         !año_envio == '2018') %>% 
  tabla_format()
```

## 2017

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         !año_envio == '2017') %>% 
  tabla_format()
```
:::

## Ecuador

::: panel-tabset
## Total 2015-2020

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         !año_envio == '2022') %>% 
  tabla_format_2()
```

## 2020

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2020') %>% 
  tabla_format()
```
## 2019

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2019') %>% 
  tabla_format()
```

## 2018

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2018') %>% 
  tabla_format()
```

## 2017

```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2017') %>% 
  tabla_format()
```

:::

:::

### Principales exportadoras del calamar/pota

```{r}
format_table_empresas <- function(data_input){
  
  data_input %>% 
    group_by(expedidor) %>% 
    summarise(
    peso_bruto_tm = sum(peso_bruto_ton,na.rm = T)
  ) %>%
    mutate(
      porcentaje = peso_bruto_tm*100/sum(peso_bruto_tm,na.rm = T)
    ) %>% 
  arrange(-peso_bruto_tm) %>% 
     left_join(
   data_input %>% 
      group_by(expedidor, año_envio) %>% 
      summarise(
        peso_bruto_tm = sum(peso_bruto_ton,na.rm = T)
      ) %>% 
  arrange(año_envio) %>% 
  pivot_wider(names_from = año_envio,values_from = peso_bruto_tm) %>% 
  pivot_longer(cols = -1, names_to = "año_envio", values_to = "peso_bruto_tm") %>% 
  mutate(
    peso_bruto_tm = case_when(
      is.na(peso_bruto_tm) ~ 0,
      T ~ peso_bruto_tm
    )
  ) %>% 
  group_by(expedidor) %>% 
  summarise(
    evolution_tm = list(peso_bruto_tm)
  )
  ) %>% 
  reactable(
    columns = list(
      expedidor = colDef(
        footer = "Total"),
      peso_bruto_tm = colDef(
        format = colFormat(suffix = " TM", digits = 0, separators = T,locales = "es-AR"),
        footer = function(values) paste0(format(round(sum(values),digits = 0), big.mark = ".")," TM")),
      porcentaje = colDef(
        format = colFormat(suffix = " %", digits = 2, separators = T,locales = "es-AR")),
      evolution_tm = colDef(
        cell = function(values) {
    sparkline(values, type = "bar", chartRangeMin = 0)
  })
    ),
    defaultColDef = colDef(footerStyle = list(fontWeight = "bold"))
  )
}

```


::: panel-tabset

## Perú

::: panel-tabset

## 2015 - 2021
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         !año_envio == '2022') %>% 
  format_table_empresas()

```
## 2021
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2021') %>% 
  format_table_empresas()

```

## 2020
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2020') %>% 
  format_table_empresas()
```

## 2019
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2019') %>% 
  format_table_empresas()
```

## 2018
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2018') %>% 
  format_table_empresas()
```

## 2017
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Perú',
         año_envio == '2017') %>% 
  format_table_empresas()
```

::: 

## Chile

::: panel-tabset

## 2015-2021
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         !año_envio == '2022') %>% 
  format_table_empresas()
```
## 2021
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         año_envio == '2021') %>% 
  format_table_empresas()
```

## 2020
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         año_envio == '2020') %>% 
  format_table_empresas()
```

## 2019
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         año_envio == '2019') %>% 
  format_table_empresas()
```

## 2018
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         año_envio == '2018') %>% 
  format_table_empresas()
```

## 2017
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Chile',
         año_envio == '2017') %>% 
  format_table_empresas()
```
::: 


## Ecuador

::: panel-tabset

## 2015-2020
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador') %>% 
  format_table_empresas()
```
## 2020
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2020') %>% 
  format_table_empresas()
```

## 2019
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2019') %>% 
  format_table_empresas()
```

## 2018
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2018') %>% 
  format_table_empresas()
```

## 2017
```{r}
exports_calamar %>% 
  filter(fuente_data == 'Ecuador',
         año_envio == '2017') %>% 
  format_table_empresas()
```
::: 
:::