<head>
    <meta charset="utf-8" />
    <title>Puerto Chcancay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet"/>    "></script></head>


<body>
    <div id="map"></div>
    <div id="minimap"></div>
    <div id="console">
        <h1>Modificaciones Puerto de Chancay</h1>
        <p>
            El área de influencia del Puerto de Chancay fue modificado cuatro veces desde el 2013, según el
            <a href="https://consultaciudadana.senace.gob.pe/#/home">Servicio Nacional de Certificación Ambiental para las Inversiones Sostenibles (SENACE).</a>
        </p>
        <div class="session" id="sliderbar">
            <div class="year-display">
                <h2>Año</h2>
                <span id="active-year">2013</span>
            </div>
            <input id="slider" class="row" type="range" min="2013" max="2023" step="1" value="2013" />
            <div class="button-container">
                <button id="play-pause">Mostrar cambios</button>
            </div>
        </div>
        <div class="year-buttons">
            <button class="year-btn" data-year="2013">2013</button>
            <button class="year-btn" data-year="2015">2015</button>
            <button class="year-btn" data-year="2020">2020</button>
            <button class="year-btn" data-year="2023">2023</button>
        </div>
    </div>
</body>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }

    #console {
        position: absolute;
        width: 240px;
        margin: 10px;
        padding: 10px 20px;
        background-color: white;
    }

    h1 {
        font-size: 20px;
        line-height: 30px;
    }

    h2 {
        font-size: 14px;
        line-height: 20px;
        margin-bottom: 10px;
    }

    a {
        text-decoration: underline;
        color: black;
        transition: color 0.3s ease;
    }

    a:hover {
        color: #F8BB31;
    }

    .session {
        margin-bottom: 20px;
    }

    .year-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 15px;
    }

    #active-year {
        font-size: 36px;
        font-weight: bold;
        color: #F8BB31;
    }

    #slider {
        width: 100%;
        -webkit-appearance: none;
        height: 15px;
        border-radius: 5px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        transition: opacity .2s;
    }

    #slider:hover {
        opacity: 1;
    }

    #slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #F8BB31;
        cursor: pointer;
    }

    #slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #F8BB31;
        cursor: pointer;
    }

    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 15px;
    }

    #play-pause {
        padding: 8px 16px;
        font-size: 18px;
        background-color: #F8BB31;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #play-pause:hover {
        background-color: #E5A929;
    }

    .year-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }

    .year-btn {
        flex: 1;
        padding: 8px 0;
        font-size: 14px;
        background-color: white;
        border: 1px solid #F8BB31;
        color: #F8BB31;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 2px;
    }

    .year-btn:first-child {
        margin-left: 0;
    }

    .year-btn:last-child {
        margin-right: 0;
    }

    .year-btn:hover, .year-btn.active {
        background-color: #F8BB31;
        color: white;
    }

    @media (max-width: 480px) {
        #console {
            width: calc(100% - 40px);
            margin: 10px auto;
        }

        .year-btn {
            font-size: 12px;
            padding: 6px 0;
        }
    }

    #minimap {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid #F8BB31;
    }

    #minimap-center-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid #F8BB31;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }
</style>

<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoib2pvcHVibGljbyIsImEiOiJja2x5MmN2N28xMnh4MnBudmxycHcwNmM1In0.ACkesvfEheuWxy0XPQtw7g';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/ojopublico/cm0ft4lzb01v701qrgrjdcooa/draft',
        center: [-77.32000, -11.59772],
        zoom: 10.6,
    });

    const years = [2013, 2015, 2020, 2023];
    const layers = {};
    let currentYearIndex = 0;
    let isPlaying = false;
    let playInterval;

    map.on('load', () => {        
        years.forEach(year => {
            const layerId = `area-influencia-${year}`;
            map.addSource(layerId, {
                type: 'geojson',
                data: `./c${year}_area_influencia_reprojected.geojson`
            });

            map.addLayer({
                id: layerId,
                type: 'fill',
                source: layerId,
                paint: {
                    'fill-color': '#F8BB31',
                    'fill-opacity': 0.5
                },
                layout: {
                    visibility: 'none'
                }
            });

            map.addLayer({
                id: `${layerId}-outline`,
                type: 'line',
                source: layerId,
                paint: {
                    'line-color': '#FFFFFF',
                    'line-width': 2
                },
                layout: {
                    visibility: 'none'
                }
            });

            layers[year] = {
                fill: layerId,
                outline: `${layerId}-outline`
            };
        });

        const slider = document.getElementById('slider');
        const playPauseButton = document.getElementById('play-pause');
        const yearButtons = document.querySelectorAll('.year-btn');

        slider.addEventListener('input', updateMap);
        playPauseButton.addEventListener('click', togglePlay);
        yearButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const selectedYear = parseInt(e.target.dataset.year);
                slider.value = selectedYear;
                updateMap();
                updateActiveButton(selectedYear);
            });
        });

        function updateMap() {
            const selectedYear = parseInt(slider.value);
            const closestYear = years.reduce((prev, curr) => 
                Math.abs(curr - selectedYear) < Math.abs(prev - selectedYear) ? curr : prev
            );
            
            // Hide all layers
            years.forEach(year => {
                map.setLayoutProperty(layers[year].fill, 'visibility', 'none');
                map.setLayoutProperty(layers[year].outline, 'visibility', 'none');
            });

            // Show the selected year's layer
            map.setLayoutProperty(layers[closestYear].fill, 'visibility', 'visible');
            map.setLayoutProperty(layers[closestYear].outline, 'visibility', 'visible');

            document.getElementById('active-year').innerText = closestYear;
            currentYearIndex = years.indexOf(closestYear);
            updateActiveButton(closestYear);
        }

        function updateActiveButton(activeYear) {
            yearButtons.forEach(button => {
                if (parseInt(button.dataset.year) === activeYear) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            playPauseButton.textContent = isPlaying ? 'Pausar' : 'Mostrar cambios';

            if (isPlaying) {
                startAnimation();
            } else {
                clearInterval(playInterval);
            }
        }

        function startAnimation() {
            playInterval = setInterval(() => {
                currentYearIndex = (currentYearIndex + 1) % years.length;
                slider.value = years[currentYearIndex];
                updateMap();
            }, 1500); // Change every 1.5 seconds
        }

        // Initialize the map with the first year
        updateMap();
        updateActiveButton(years[0]);

        // Auto-start the animation
        setTimeout(() => {
            isPlaying = true;
            playPauseButton.textContent = 'Pausar';
            startAnimation();
        }, 1000); // Start after a 1-second delay to ensure map is fully loaded

        // Add minimap
        class MinimapControl {
            onAdd(map) {
                this._map = map;
                this._container = document.getElementById('minimap');
                this._minimap = new mapboxgl.Map({
                    container: this._container,
                    style: 'mapbox://styles/mapbox/light-v11',
                    center: map.getCenter(),
                    zoom: -0.1,
                    interactive: false,
                    attributionControl: false  // This line removes the attribution control
                });
                
                // Add center indicator
                const centerIndicator = document.createElement('div');
                centerIndicator.id = 'minimap-center-indicator';
                this._container.appendChild(centerIndicator);

                this._map.on('move', () => {
                    this._minimap.setCenter(this._map.getCenter());
                });

                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }

        map.addControl(new MinimapControl(), 'bottom-right');
    });
</script>