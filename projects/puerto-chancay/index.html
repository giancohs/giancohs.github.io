<head>
    <meta charset="utf-8" />
    <title>Puerto Chancay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet"/>    "></script></head>


<body>
    <div id="map"></div>
    <div id="minimap"></div>
    <div id="console">
        <div class="console-content">
            <h1>Las enormes modificaciones a la construcción del puerto de Chancay</h1>
            <p>
                El área de influencia del proyecto ha sido modificado cuatro veces desde el 2013: creció de 3,3 a 25,9 kilómetros cuadrados en nueve años. Lo que implica un crecimiento de 685%, de acuerdo a lo declarado por la empresa Senace.
            </p>
            <div class="session" id="sliderbar">
                <div class="year-display">
                    <h2>Año</h2>
                    <span id="active-year">2013</span>
                </div>
                <input id="slider" class="row" type="range" min="2013" max="2023" step="1" value="2013" />
                <div class="button-container">
                    <button id="play-pause">Mostrar cambios</button>
                </div>
            </div>
            <div class="year-buttons">
                <button class="year-btn" data-year="2013">2013</button>
                <button class="year-btn" data-year="2015">2015</button>
                <button class="year-btn" data-year="2020">2020</button>
                <button class="year-btn" data-year="2023">2023</button>
            </div>
        </div>
    </div>
</body>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }

    #console {
        position: absolute;
        width: 240px;
        margin: 10px;
        padding: 10px 20px;
        background-color: white;
    }

    h1 {
        font-size: 25px;
        line-height: 22px;
    }

    h2 {
        font-size: 14px;
        line-height: 20px;
        margin-bottom: 10px;
    }

    a {
        text-decoration: underline;
        color: black;
        transition: color 0.3s ease;
    }

    a:hover {
        color: #F8BB31;
    }

    .session {
        margin-bottom: 20px;
    }

    .year-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 15px;
    }

    #active-year {
        font-size: 36px;
        font-weight: bold;
        color: #F8BB31;
    }

    #slider {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 15px;
        border-radius: 5px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        transition: opacity .2s;
    }

    #slider:hover {
        opacity: 1;
    }

    #slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #F8BB31;
        cursor: pointer;
    }

    #slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #F8BB31;
        cursor: pointer;
    }

    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 15px;
    }

    #play-pause {
        padding: 8px 16px;
        font-size: 18px;
        background-color: #F8BB31;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #play-pause:hover {
        background-color: #E5A929;
    }

    .year-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }

    .year-btn {
        flex: 1;
        padding: 8px 0;
        font-size: 14px;
        background-color: white;
        border: 1px solid #F8BB31;
        color: #F8BB31;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 2px;
    }

    .year-btn:first-child {
        margin-left: 0;
    }

    .year-btn:last-child {
        margin-right: 0;
    }

    .year-btn:hover, .year-btn.active {
        background-color: #F8BB31;
        color: white;
    }

    @media (max-width: 768px) {
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        #minimap {
            display: none;
        }

        #console {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 2;
            padding: 10px;
            box-sizing: border-box;
            margin: 0;
        }
        #console * {
            font-size: 85%;  /* Reduce font size to 85% for all text elements */
        }

        #console h1 {
            font-size: 20px;  /* Adjust this value as needed */
            line-height: 1.1;  /* Set a specific line height in pixels */
            margin-bottom: 0px;
        }  

        /* New styles for the year display*/
        #console .year-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 0px;
            margin-top: 0px;
        }

        #console .year-display h2 {
            font-size: 15px;  /* Adjust as needed */
            margin-bottom: 0px;
            margin-top: 0px;
            
        }

        #console #active-year {
            font-size: 25px;  /* Larger font size for the year */
            font-weight: bold;
            color: #F8BB31;   /* Assuming you want to keep the same color */
            display: block;   /*  Ensures it's on its own line */
            margin-top: 0px;
            margin-bottom: 0px;

        }

        /* Adjust other elements as needed */
        #console input[type="range"] {
            width: 90%;  /* Slightly narrower than full width */
            height: 15px;  /* Slightly taller for better touch interaction */
            margin: 10px auto;  /* Center the slider and add vertical spacing */
        }

        #console input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;   /* Larger thumb size for mobile */
            height: 25px;  /* Larger thumb size for mobile */
            background: #F8BB31;
            cursor: pointer;
            border-radius: 50%;
        }
        #console input[type="range"]::-moz-range-thumb {
            width: 25px;  /* Larger thumb size for mobile */
            height: 25px;  /* Larger thumb size for mobile */
            background: #F8BB31;
            cursor: pointer;
            border-radius: 50%;
        }
        
        #console button {
            padding: 5px 10px;  /* Adjust button padding if necessary */
        }

        /* Adjust the container of the slider if needed */
        #console #sliderbar {
            padding: 0 5%;   /*  Add some padding to the slider container */
        }
    }

    #minimap {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid #F8BB31;
    }

    #minimap-center-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid #F8BB31;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }
</style>

<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoib2pvcHVibGljbyIsImEiOiJja2x5MmN2N28xMnh4MnBudmxycHcwNmM1In0.ACkesvfEheuWxy0XPQtw7g';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/ojopublico/cm0ft4lzb01v701qrgrjdcooa/draft',
        center: [-77.32000, -11.59772],
        zoom: 10.6,
        // Add these options:
        dragPan: !isMobile(),
        scrollZoom: !isMobile(),
        touchZoomRotate: !isMobile()
    });

    // Add this function to check if the device is mobile
    function isMobile() {
        return window.innerWidth <= 768;
    }

    const years = [2013, 2015, 2020, 2023];
    const layers = {};
    let currentYearIndex = 0;
    let isPlaying = false;
    let playInterval;

    map.on('load', () => {        
        years.forEach(year => {
            const layerId = `area-influencia-${year}`;
            map.addSource(layerId, {
                type: 'geojson',
                data: `./c${year}_area_influencia_reprojected.geojson`
            });

            map.addLayer({
                id: layerId,
                type: 'fill',
                source: layerId,
                paint: {
                    'fill-color': '#F8BB31',
                    'fill-opacity': 0.5
                },
                layout: {
                    visibility: 'none'
                }
            });

            map.addLayer({
                id: `${layerId}-outline`,
                type: 'line',
                source: layerId,
                paint: {
                    'line-color': '#FFFFFF',
                    'line-width': 2
                },
                layout: {
                    visibility: 'none'
                }
            });

            layers[year] = {
                fill: layerId,
                outline: `${layerId}-outline`
            };

            // Add new layers for 2013 and 2015
            if (year === 2013) {
                map.addSource('area-proyecto-2013', {
                    type: 'geojson',
                    data: './area_projecto_2013.geojson'
                });

                map.addLayer({
                    id: 'area-proyecto-2013',
                    type: 'fill',
                    source: 'area-proyecto-2013',
                    paint: {
                        'fill-color': '#FF0000',  // Red color, adjust as needed
                        'fill-opacity': 0.5
                    },
                    layout: {
                        visibility: 'none'
                    }
                });

                layers[2013]['proyecto'] = 'area-proyecto-2013';
            }

            if (year === 2015) {
                map.addSource('viaducto-proyecto-2015', {
                    type: 'geojson',
                    data: './viaducto_proyecto_2015.geojson'
                });                             

                map.addLayer({
                    id: 'viaducto-proyecto-2015',
                    type: 'line',  // Assuming it's a line feature
                    source: 'viaducto-proyecto-2015',
                    paint: {
                        'line-color': '#FF0000',  // Red color, adjust as needed
                        'line-width': 2,
                        'line-opacity': 0.5
                    },
                    layout: {
                        visibility: 'none'
                    }
                });

                map.addLayer({
                    id: 'area-proyecto-2015',
                    type: 'fill',
                    source: 'area-proyecto-2013',
                    paint: {
                        'fill-color': '#FF0000',  // Red color, adjust as needed
                        'fill-opacity': 0.5
                    },
                    layout: {
                        visibility: 'none'
                    }
                });

                layers[2015]['proyecto'] = 'area-proyecto-2015';
                layers[2015]['viaducto'] = 'viaducto-proyecto-2015';
            }

            if (year === 2020) {
                map.addSource('area-proyecto-2020', {
                    type: 'geojson',
                    data: './area_proyecto_2020.geojson'
                });

                map.addLayer({
                    id: 'area-proyecto-2020',
                    type: 'fill',
                    source: 'area-proyecto-2020',
                    paint: {
                        'fill-color': '#FF0000',  // Red color, adjust as needed
                        'fill-opacity': 0.5
                    },
                    layout: {
                        visibility: 'none'
                    }
                });

                layers[2020]['proyecto'] = 'area-proyecto-2020';     

            }              

            if (year === 2023) {
                map.addSource('modificacion-proyecto-2023', {
                    type: 'geojson',
                    data: './modificacion_2023_proyecto.geojson'
                });

                map.addLayer({
                    id: 'modificacion-proyecto-2023',
                    type: 'fill',
                    source: 'modificacion-proyecto-2023',
                    paint: {
                        'fill-color': '#FF0000',  // Red color, adjust as needed
                        'fill-opacity': 0.5
                    },
                    layout: {
                        visibility: 'none'
                    }
                });

                map.addLayer({
                    id: 'area-proyecto-2023',
                    type: 'fill',
                    source: 'area-proyecto-2020',
                    paint: {
                        'fill-color': '#FF0000',  // Red color, adjust as needed
                        'fill-opacity': 0.5
                    },
                    layout: {
                        visibility: 'none'
                    }
                });                     

                layers[2023]['viaducto'] = 'area-proyecto-2023';
                layers[2023]['proyecto'] = 'modificacion-proyecto-2023';
            }
        });

        const slider = document.getElementById('slider');
        const playPauseButton = document.getElementById('play-pause');
        const yearButtons = document.querySelectorAll('.year-btn');

        slider.addEventListener('input', updateMap);
        playPauseButton.addEventListener('click', togglePlay);
        yearButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const selectedYear = parseInt(e.target.dataset.year);
                slider.value = selectedYear;
                updateMap();
                updateActiveButton(selectedYear);
                
                // Pause the autoplay when clicking a year button
                if (isPlaying) {
                    togglePlay();
                }
            });
        });

        function updateMap() {
            const selectedYear = parseInt(slider.value);
            const closestYear = years.reduce((prev, curr) => 
                Math.abs(curr - selectedYear) < Math.abs(prev - selectedYear) ? curr : prev
            );
            
            // Hide all layers
            years.forEach(year => {
                map.setLayoutProperty(layers[year].fill, 'visibility', 'none');
                map.setLayoutProperty(layers[year].outline, 'visibility', 'none');
                if (layers[year].proyecto) {
                    map.setLayoutProperty(layers[year].proyecto, 'visibility', 'none');
                }
                if (layers[year].viaducto) {
                    map.setLayoutProperty(layers[year].viaducto, 'visibility', 'none');
                }
            });

            // Show the selected year's layers
            map.setLayoutProperty(layers[closestYear].fill, 'visibility', 'visible');
            map.setLayoutProperty(layers[closestYear].outline, 'visibility', 'visible');
            if (layers[closestYear].proyecto) {
                map.setLayoutProperty(layers[closestYear].proyecto, 'visibility', 'visible');
            }
            if (layers[closestYear].viaducto) {
                map.setLayoutProperty(layers[closestYear].viaducto, 'visibility', 'visible');
            }

            document.getElementById('active-year').innerText = closestYear;
            currentYearIndex = years.indexOf(closestYear);
            updateActiveButton(closestYear);
        }

        function updateActiveButton(activeYear) {
            yearButtons.forEach(button => {
                if (parseInt(button.dataset.year) === activeYear) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            playPauseButton.textContent = isPlaying ? 'Pausar' : 'Mostrar cambios';

            if (isPlaying) {
                startAnimation();
            } else {
                clearInterval(playInterval);
            }
        }

        function startAnimation() {
            playInterval = setInterval(() => {
                currentYearIndex = (currentYearIndex + 1) % years.length;
                slider.value = years[currentYearIndex];
                updateMap();
            }, 1500); // Change every 1.5 seconds
        }

        // Initialize the map with the first year
        updateMap();
        updateActiveButton(years[0]);

        // Auto-start the animation
        setTimeout(() => {
            isPlaying = true;
            playPauseButton.textContent = 'Pausar';
            startAnimation();
        }, 1000); // Start after a 1-second delay to ensure map is fully loaded

        // Add minimap
        class MinimapControl {
            onAdd(map) {
                this._map = map;
                this._container = document.getElementById('minimap');
                this._minimap = new mapboxgl.Map({
                    container: this._container,
                    style: 'mapbox://styles/mapbox/light-v11',
                    center: map.getCenter(),
                    zoom: -0.1,
                    interactive: false,
                    attributionControl: false  // This line removes the attribution control
                });
                
                // Add center indicator
                const centerIndicator = document.createElement('div');
                centerIndicator.id = 'minimap-center-indicator';
                this._container.appendChild(centerIndicator);

                this._map.on('move', () => {
                    this._minimap.setCenter(this._map.getCenter());
                });

                return this._container;
            }

            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }

        map.addControl(new MinimapControl(), 'bottom-right');

        // Add this function
        function updateMapSize() {
            map.resize();
        }

        // Call this function when the window is resized
        window.addEventListener('resize', updateMapSize);

        // Add this function to update map interactivity and view
        function updateMapForMobile() {
            if (isMobile()) {
                map.setCenter([-77.28000, -11.50772]);
                map.setZoom(10.3);  // Adjust this value to fit the area of interest on mobile
                map.dragPan.disable();
                map.scrollZoom.disable();
                map.touchZoomRotate.disable();
            } else {
                map.setCenter([-77.32000, -11.59772]);
                map.setZoom(10.6);
                map.dragPan.enable();
                map.scrollZoom.enable();
                map.touchZoomRotate.enable();
            }
        }

        // Call this function initially and on window resize
        updateMapForMobile();
        window.addEventListener('resize', updateMapForMobile);
    });
</script>